
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://grex-telescope.github.io/software/server_setup/">
      
      <link rel="icon" href="../../assets/grex_icon.svg">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.15">
    
    
      
        <title>Server Setup - GReX Telescope</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.c382b1dc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#server-setup" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="GReX Telescope" class="md-header__button md-logo" aria-label="GReX Telescope" data-md-component="logo">
      
  <img src="../../assets/grex_icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GReX Telescope
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Server Setup
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../hardware/overview/" class="md-tabs__link">
        Hardware
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../overview/" class="md-tabs__link md-tabs__link--active">
        Software
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="GReX Telescope" class="md-nav__button md-logo" aria-label="GReX Telescope" data-md-component="logo">
      
  <img src="../../assets/grex_icon.svg" alt="logo">

    </a>
    GReX Telescope
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Hardware
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hardware" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Hardware
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/feed/" class="md-nav__link">
        Feed Antenna
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/fem/" class="md-nav__link">
        Fronend Module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/fpga/" class="md-nav__link">
        Digital Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/box/" class="md-nav__link">
        The Box
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/assembly/" class="md-nav__link">
        Assembly Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Software
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Software" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stack/" class="md-nav__link">
        Software Stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gateware.md" class="md-nav__link">
        Gateware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../snap/" class="md-nav__link">
        SNAP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/" class="md-nav__link">
        Pipeline
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Server Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Server Setup
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hardware-setup" class="md-nav__link">
    Hardware Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-os-setup" class="md-nav__link">
    Initial OS Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    Networking
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#netplan" class="md-nav__link">
    Netplan
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhcp-server" class="md-nav__link">
    DHCP Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-10-gbe-settings" class="md-nav__link">
    Advanced 10 GbE Settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guix" class="md-nav__link">
    Guix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust" class="md-nav__link">
    Rust
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipeline-software" class="md-nav__link">
    Pipeline Software
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prometheus" class="md-nav__link">
    Prometheus
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hardware-setup" class="md-nav__link">
    Hardware Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-os-setup" class="md-nav__link">
    Initial OS Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#networking" class="md-nav__link">
    Networking
  </a>
  
    <nav class="md-nav" aria-label="Networking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#netplan" class="md-nav__link">
    Netplan
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dhcp-server" class="md-nav__link">
    DHCP Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-10-gbe-settings" class="md-nav__link">
    Advanced 10 GbE Settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guix" class="md-nav__link">
    Guix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust" class="md-nav__link">
    Rust
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipeline-software" class="md-nav__link">
    Pipeline Software
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prometheus" class="md-nav__link">
    Prometheus
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="server-setup">Server Setup</h1>
<p>Once you get your server (either from Puget systems or otherwise), we need to setup additional hardware, adjust some system settings, setup networking, and install the pipeline software.</p>
<h2 id="hardware-setup">Hardware Setup</h2>
<p>The server straight from Puget does not have the GPU or 10 GbE network card installed, we will do this first.</p>
<ol>
<li>Open the case and remove the GPU retention bracket</li>
<li>Remove the test GPU (T1000), keep this for later in case we need an aditional video output</li>
<li>Install the 3090 Ti in the first GPU slot, this will take up three slots of space</li>
<li>Install the network card in the bottom slot</li>
<li>Wire the 3090 Ti power cable to the harness provided by Puget (they knew this was the GPU we were going to install)</li>
<li>Remove the GPU retention clips from the retention bracket that would interfere with the card. It's too tall for it anyway.</li>
<li>Replace the retention bracket and close the case.</li>
</ol>
<p><img alt="" src="../../assets/server.jpg" /></p>
<p>Finally, we need to hook up a monitor to the 3090 Ti so we can setup the software</p>
<h2 id="initial-os-setup">Initial OS Setup</h2>
<p>On boot, you will be presented with the Ubuntu graphical interface. If a password is requested, the deafult is provided in the information booklet that came with the hardware.</p>
<p>First, we will change the system password. Set this to something memorable.</p>
<div class="highlight"><pre><span></span><code>passwd <span class="k">$(</span>whoami<span class="k">)</span>
</code></pre></div>
<p>Now, we will update the system. There shouldn't be many updates if this is a new machine.</p>
<div class="highlight"><pre><span></span><code>sudo apt-get update
sudo apt-get upgrade -y
</code></pre></div>
<p>We will be editing a bunch of files, if you are comfy in the command line, you probably want to install some editors. Otherwise the graphical <code>gedit</code> tool will be fine.</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install emacs vim -y
</code></pre></div>
<p>Finally, we will set the hostname. We'll be using the <code>grex-&lt;affiliation&gt;-&lt;location&gt;</code> paradigm (just for clarity, no real reason not to).
As in, the first server that is managed by Caltech at OVRO will be <code>grex-caltech-ovro</code>.</p>
<div class="highlight"><pre><span></span><code>sudo hostnamectl set-hostname &lt;your-hostname&gt;
</code></pre></div>
<p>Some updates may require a reboot. If it asks, do that now.</p>
<h2 id="networking">Networking</h2>
<p>Now, we need to setup the networking for the GReX system. We will operate under the assumption that the internet-facing connection will get an IP address from a DHCP server. If that is not the case, consult whoever runs your network on the appropriate setup. Regardless of the WAN connection, the 10 GbE fiber connection to the GReX terminal will be configured the same.</p>
<h3 id="overview">Overview</h3>
<p>The 10 GbE fiber port serves a few purposes. It is the main data transfer link between the FPGA in the field and the server, but it also carries the monitor and control for the box. This monitor and control connection includes the SNAP control connection and the Raspberry Pi. The SNAP requires an external DHCP server, which we have to provide on this port. Additionally, the 10 GbE switch in the box has its own default subnet for configuration (<code>192.168.88.X</code>). To make everything talk to each other, we need to add two IPs on this port: one in the subnet of the switch's config interface, and the other for DHCP of the various devices.</p>
<h3 id="netplan">Netplan</h3>
<p>In <code>/etc/netplan</code> remove any files that are currently there.</p>
<p>Then, create a new file called <code>config.yaml</code> with the following contents</p>
<div class="highlight"><pre><span></span><code><span class="nt">network</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="w">    </span><span class="nt">renderer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networkd</span><span class="w"></span>
<span class="w">    </span><span class="nt">ethernets</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="c1"># Two WAN interfaces. Configure this according to your network setup</span><span class="w"></span>
<span class="w">        </span><span class="nt">enp36s0f0</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">dhcp4</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">enp36s0f1</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">dhcp4</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="c1"># 10 GbE connection over fiber to the box</span><span class="w"></span>
<span class="w">        </span><span class="nt">enp1s0f0</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span><span class="w"></span>
<span class="w">            </span><span class="nt">addresses</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.1/24</span><span class="w"></span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.88.2/24</span><span class="w"></span>
</code></pre></div>
<p>Then apply with</p>
<div class="highlight"><pre><span></span><code>sudo netplan apply
</code></pre></div>
<h3 id="dhcp-server">DHCP Server</h3>
<p>Now, we need to setup the DHCP server on the 10 GbE port. First, we install the DHCP server software:</p>
<p>Setup the repository that includes kea</p>
<div class="highlight"><pre><span></span><code>curl -1sLf <span class="se">\</span>
  <span class="s1">&#39;https://dl.cloudsmith.io/public/isc/kea-2-3/setup.deb.sh&#39;</span> <span class="se">\</span>
  <span class="p">|</span> sudo -E bash
</code></pre></div>
<p>Then install with 
<div class="highlight"><pre><span></span><code>sudo apt-get install isc-kea-dhcp4
</code></pre></div></p>
<p>Now, remove the example file:</p>
<div class="highlight"><pre><span></span><code>sudo rm /etc/kea/kea-dhcp4.conf
</code></pre></div>
<p>And replace it with a file called <code>kea-dhcp4.conf</code> with the following contents:</p>
<p><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;Dhcp4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;interfaces-config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;interfaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;enp1s0f0&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;service-sockets-max-retries&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;service-sockets-retry-wait-time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;lease-database&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;memfile&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;persist&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/lib/kea/kea-leases4.csv&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;lfc-interval&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;renew-timer&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">15840</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;rebind-timer&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">27720</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;valid-lifetime&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">31680</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;subnet4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;subnet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.0.0/24&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;pools&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nt">&quot;pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.0.4 - 192.168.0.100&quot;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">],</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;option-data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routers&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.0.1&quot;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">],</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;reservations&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nt">&quot;hw-address&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;00:24:1D:1B:15:12&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nt">&quot;ip-address&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.0.3&quot;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">]</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
This sets up a more or less standard DHCP instance, with one static allocation for the SNAP FPGA, as we're hard-coding it's MAC address in the gateware.</p>
<p>Finally enable the DHCP server service</p>
<div class="highlight"><pre><span></span><code>sudo systemctl <span class="nb">enable</span> isc-kea-dhcp4-server
</code></pre></div>
<p>And check the status to make sure everything came up ok</p>
<div class="highlight"><pre><span></span><code>sudo systemctl status isc-kea-dhcp4-server
</code></pre></div>
<p>Finally,</p>
<div class="highlight"><pre><span></span><code>sudo reboot
</code></pre></div>
<p>After reboot, assuming your fiber line is plugged into the box, you can check the leases by looking at</p>
<div class="highlight"><pre><span></span><code>cat /var/lib/kea/kea-leases4.csv
</code></pre></div>
<h3 id="advanced-10-gbe-settings">Advanced 10 GbE Settings</h3>
<p>Unfortunatley, the OS's default configuration for the 10 GbE network card is not optimized for our use-case of streaming time domain science data. As such, we need to adjust a few things.</p>
<p>Add the following to <code>/etc/sysctl.conf</code></p>
<div class="highlight"><pre><span></span><code>kernel.shmmax = 68719476736
kernel.shmall = 4294967296
net.core.rmem_max = 536870912
net.core.wmem_max = 536870912
net.core.optmem_max = 16777216
vm.swappiness=1
</code></pre></div>
<p>Then apply these changes with </p>
<div class="highlight"><pre><span></span><code>sudo sysctl --system
</code></pre></div>
<p>Now, we need a program called <code>ethtool</code> to apply some more settings</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install ethtool -y
</code></pre></div>
<p>Now we will create a file to run on boot to apply a sequence of ethtool settings.</p>
<p>Create the file <code>/etc/rc.local</code> with the following contents:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/env bash</span>
ethtool -G enp1s0f0 rx <span class="m">4096</span> tx <span class="m">4096</span>
ethtool -A enp1s0f0 rx on
ethtool -A enp1s0f0 tx on
</code></pre></div>
<p>Make this file executable with</p>
<div class="highlight"><pre><span></span><code>sudo chmod +x /etc/rc.local
</code></pre></div>
<p>Then enable the <code>rc-local</code> service</p>
<div class="highlight"><pre><span></span><code>sudo systemctl <span class="nb">enable</span> rc-local
</code></pre></div>
<p>Now create the file <code>/etc/systemd/system/rc-local.service</code> with the following contents:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span><span class="w"></span>
<span class="w"> </span><span class="na">Description</span><span class="o">=</span><span class="s">/etc/rc.local Compatibility</span><span class="w"></span>
<span class="w"> </span><span class="na">ConditionPathExists</span><span class="o">=</span><span class="s">/etc/rc.local</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="w"> </span><span class="na">Type</span><span class="o">=</span><span class="s">forking</span><span class="w"></span>
<span class="w"> </span><span class="na">ExecStart</span><span class="o">=</span><span class="s">/etc/rc.local start</span><span class="w"></span>
<span class="w"> </span><span class="na">TimeoutSec</span><span class="o">=</span><span class="s">0</span><span class="w"></span>
<span class="w"> </span><span class="na">StandardOutput</span><span class="o">=</span><span class="s">tty</span><span class="w"></span>
<span class="w"> </span><span class="na">RemainAfterExit</span><span class="o">=</span><span class="s">yes</span><span class="w"></span>
<span class="w"> </span><span class="na">SysVStartPriority</span><span class="o">=</span><span class="s">99</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="w"> </span><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</code></pre></div>
<p>Finally, reboot</p>
<h2 id="guix">Guix</h2>
<p>We use the deterministic pacakge manager Guix to deal with the more tricky to install things, so we never have to worry about stuff not building.</p>
<p>You can install this with the Ubuntu package manager</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install guix
</code></pre></div>
<p>Then, we will add the repository of our pacakges by creating the following file <code>~/.config/guix/channels.scm</code></p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nv">channel</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="ss">&#39;guix-grex</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">url</span><span class="w"> </span><span class="s">&quot;https://github.com/GReX-Telescope/guix-grex.git&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="nv">branch</span><span class="w"> </span><span class="s">&quot;main&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="nv">%default-channels</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>And then have it self-update with</p>
<div class="highlight"><pre><span></span><code>guix pull
</code></pre></div>
<p>This step may take a while.</p>
<p>Create (or add to) <code>~/.bash_profile</code> </p>
<div class="highlight"><pre><span></span><code><span class="nv">GUIX_PROFILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.guix-profile&quot;</span>
. <span class="s2">&quot;</span><span class="nv">$GUIX_PROFILE</span><span class="s2">/etc/profile&quot;</span>
<span class="k">if</span> <span class="o">[</span> -f ~/.bashrc <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">source</span> ~/.bashrc
<span class="k">fi</span>
</code></pre></div>
<p>In here, we're also souring <code>~/.bashrc</code> so we get it over ssh.</p>
<p>Finally, install the pipeline dependencies with:</p>
<div class="highlight"><pre><span></span><code>guix install psrdada snap_bringup heimdall-astro
</code></pre></div>
<h2 id="rust">Rust</h2>
<p>Many parts of the pipeline software are written in the Rust programming language.
We will build be building this software from scratch, so we need to install the rust compiler and it's tooling.
This is easy enough with <a href="https://rustup.rs/">rustup</a></p>
<p>We need curl for the rustup installer, so</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install curl -y
</code></pre></div>
<p>Then run the installer, using all the default settings</p>
<div class="highlight"><pre><span></span><code>curl --proto <span class="s1">&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.rustup.rs <span class="p">|</span> sh
</code></pre></div>
<h2 id="python">Python</h2>
<p>To get out of version hell for python stuff <em>not</em> packaged with guix, we're using <a href="https://python-poetry.org/">Poetry</a>. To install it, we will:</p>
<div class="highlight"><pre><span></span><code>curl -sSL https://install.python-poetry.org <span class="p">|</span> python3 -
</code></pre></div>
<p>We need to make a few adjustments to <code>~/.bashrc</code> to correct the paths and fix a bug. Append the following to the end.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/home/user/.local/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
<span class="c1"># Fix the &quot;Poetry: Failed to unlock the collection&quot; issue</span>
<span class="nb">export</span> <span class="nv">PYTHON_KEYRING_BACKEND</span><span class="o">=</span>keyring.backends.null.Keyring
</code></pre></div>
<p>Go ahead and <code>source ~/.bashrc</code> now to get these changes in your shell.</p>
<h2 id="pipeline-software">Pipeline Software</h2>
<p>To organize all the software needed for running the whole pipeline, we will grab the metapackage from github and clone somewhere (like the home directory):</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span>
git clone --recurse-submodules https://github.com/GReX-Telescope/grex
</code></pre></div>
<p>Then, assuming you followed all the previous steps, build the pipeline software with</p>
<div class="highlight"><pre><span></span><code>./grex/build.sh
</code></pre></div>
<h2 id="prometheus">Prometheus</h2>
<p>To save data about the server (CPU usage, RAM usage, etc) and to collect monitoring metrics from various pieces of pipeline software, we use the <a href="https://prometheus.io/">prometheus</a> time series database. Each server will host its own database and <em>push</em> updates to the monitoring frontend Grafana.</p>
<p>First, create a new group and user</p>
<div class="highlight"><pre><span></span><code>sudo groupadd --system prometheus
sudo useradd -s /sbin/nologin --system -g prometheus prometheus
</code></pre></div>
<p>Next, we create the path for the database. Puget setup the system so the large storage drive is mounted at <code>/hdd</code>. We will keep the database there.</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /hdd/prometheus
</code></pre></div>
<p>Prometheus primary configuration files directory is /etc/prometheus/. It will have some sub-directories:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> i <span class="k">in</span> rules rules.d files_sd<span class="p">;</span> <span class="k">do</span> sudo mkdir -p /etc/prometheus/<span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div>
<p>Next, get a copy of the prometheus binaries, extract, and move into that dir</p>
<div class="highlight"><pre><span></span><code>mkdir -p /tmp/prometheus <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /tmp/prometheus
curl -s https://api.github.com/repos/prometheus/prometheus/releases/latest <span class="p">|</span> grep browser_download_url <span class="p">|</span> grep linux-amd64 <span class="p">|</span> cut -d <span class="s1">&#39;&quot;&#39;</span> -f <span class="m">4</span> <span class="p">|</span> wget -qi -
tar xvf prometheus*.tar.gz
<span class="nb">cd</span> prometheus*/
</code></pre></div>
<p>Install the files by moving to <code>/usr/local/bin</code></p>
<div class="highlight"><pre><span></span><code>sudo mv prometheus promtool /usr/local/bin/
</code></pre></div>
<p>Move Prometheus configuration files to <code>etc</code></p>
<div class="highlight"><pre><span></span><code>sudo mv prometheus.yml /etc/prometheus/prometheus.yml
sudo mv consoles/ console_libraries/ /etc/prometheus/
</code></pre></div>
<p>Now, we configure. Open up <code>/etc/prometheus/prometheus.yml</code> and edit to contain:</p>
<div class="highlight"><pre><span></span><code>global:
    scrape_interval: 10s
    evaluation_interval: 10s
scrape_configs:
    - job_name: &quot;prometheus&quot;
      static_configs:
      - targets: [&quot;localhost:9090&quot;, &quot;localhost:9100&quot;, &quot;localhost:8083&quot;]
remote_write:
    - url: &lt;grafana-url&gt;
      basic_auth: 
        username: &lt;grafana username&gt;
        password: &lt;grafana api key&gt;
</code></pre></div>
<p>If you are hooking up to our grafana instance, you will get an API key from the project, otherwise you'd create a <code>remote_write</code> section that reflects your monitoring stack.</p>
<p>Now, create a systemd unit to run the database in the file <code>/etc/systemd/system/prometheus.service</code></p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Prometheus</span><span class="w"></span>
<span class="na">Documentation</span><span class="o">=</span><span class="s">https://prometheus.io/docs/introduction/overview/</span><span class="w"></span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span><span class="w"></span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span><span class="w"></span>
<span class="na">User</span><span class="o">=</span><span class="s">prometheus</span><span class="w"></span>
<span class="na">Group</span><span class="o">=</span><span class="s">prometheus</span><span class="w"></span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -HUP \$MAINPID</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/prometheus \</span><span class="w"></span>
<span class="w">  </span><span class="na">--config.file</span><span class="o">=</span><span class="s">/etc/prometheus/prometheus.yml \</span><span class="w"></span>
<span class="w">  </span><span class="na">--storage.tsdb.path</span><span class="o">=</span><span class="s">/hdd/prometheus \</span><span class="w"></span>
<span class="w">  </span><span class="na">--web.console.templates</span><span class="o">=</span><span class="s">/etc/prometheus/consoles \</span><span class="w"></span>
<span class="w">  </span><span class="na">--web.console.libraries</span><span class="o">=</span><span class="s">/etc/prometheus/console_libraries \</span><span class="w"></span>
<span class="w">  </span><span class="na">--web.listen-address</span><span class="o">=</span><span class="s">0.0.0.0:9090 \</span><span class="w"></span>
<span class="w">  </span><span class="na">--web.external-url</span><span class="o">=</span><span class="w"></span>

<span class="na">SyslogIdentifier</span><span class="o">=</span><span class="s">prometheus</span><span class="w"></span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</code></pre></div>
<p>Now update all the permissions of the things we've mucked with to make sure prometheus can use them</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> i <span class="k">in</span> rules rules.d files_sd<span class="p">;</span> <span class="k">do</span> sudo chown -R prometheus:prometheus /etc/prometheus/<span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> i <span class="k">in</span> rules rules.d files_sd<span class="p">;</span> <span class="k">do</span> sudo chmod -R <span class="m">775</span> /etc/prometheus/<span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>
sudo chown -R prometheus:prometheus /hdd/prometheus/
</code></pre></div>
<p>Finally, reload systemd and start the service</p>
<div class="highlight"><pre><span></span><code>sudo systemctl daemon-reload
sudo systemctl start prometheus
sudo systemctl <span class="nb">enable</span> prometheus
</code></pre></div>
<p>Now we will install the node-exporter, which gives us metrics of the computer itself.</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install prometheus-node-exporter
</code></pre></div>
<h1 id="turning-on-the-snap">Turning on the SNAP</h1>
<p>To turn on the SNAP, SSH into the Pi (password is the same as the host machine) via</p>
<div class="highlight"><pre><span></span><code>ssh pi@192.168.0.2
</code></pre></div>
<p>Then on the pi, run</p>
<div class="highlight"><pre><span></span><code>python3 pwup_snap.py
</code></pre></div>
<p>There also exists <code>pwdn_snap.py</code>, with an obvious purpose.</p>
<h1 id="preconfigured">Preconfigured</h1>
<p>These steps should already be performed before we ship a box, but for completeness, here are the steps that we performed.</p>
<h2 id="valon">Valon</h2>
<p>We need to configure the valon synthesizer to act as the LO for the downconverter and the reference clock for the SNAP ADC.</p>
<p>Use the GUI tool <a href="https://valontechnology.com/5009users/5009.htm">here</a> to load <a href="../../assets/grex_valon.VR0">this</a> configuration file.
Next, go to synthesizer -&gt; write registers.
Then, save the configuration to flash to preserve this configuration across reboots.</p>
<h2 id="switch">Switch</h2>
<p>With the box connected and powered on, create an SSH relay to the switch's configuration interface with</p>
<div class="highlight"><pre><span></span><code>ssh -L <span class="m">8291</span>:192.168.88.1:8291 user@&lt;the ip address of the server&gt;
</code></pre></div>
<p>Then, using <a href="www.mikrotik.com/download/winbox.exe">winbox</a> connect to localhost, 
select <code>files</code> on the left, and upload <a href="../../assets/GReX_Switch.backup">this config file</a>. This should trigger a reboot.</p>
<h2 id="raspberry-pi">Raspberry Pi</h2>
<p>We prepared the RPi image using the standard <a href="https://www.raspberrypi.com/software/operating-systems/">raspbain lite OS</a>.
As part of the initial image creation, we set the hostname to <code>grex-pi</code> and enabled password-based SSH.</p>
<p>Using <code>raspi-config</code>, we did the following:
- disabled the serial login shell
- enabled the hardware serial interface</p>
<p>Then, we disabled the hardware's radios by modifying the <code>config.txt</code> file <a href="https://raspberrytips.com/disable-wifi-raspberry-pi/">like so</a>.</p>
<p>Then, we configured the Pi to have the static IP address of <code>192.168.0.2</code> by following <a href="https://www.makeuseof.com/raspberry-pi-set-static-ip/">this</a></p>
<p>Then, we disabled HCI UART by running</p>
<div class="highlight"><pre><span></span><code>sudo systemctl disable hciuart
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../pipeline/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Pipeline" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Pipeline
            </div>
          </div>
        </a>
      
      
        
        <a href="../../about/" class="md-footer__link md-footer__link--next" aria-label="Next: About" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              About
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide", "navigation.instant", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a6c66575.min.js"></script>
      
    
  </body>
</html>